SignatureVisibleType = { ONLY_TEXT: 1, BOTH: 2, ONLY_IMAGE: 3 }; var _signBox, _pdfPage, _signImage, _signText, _posX, _posY, _signWidth, _signHeigth, _defaultImage = "iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACc1BMVEUAAABGRl1KUFNKUFNLUVVLUFRNUVVLUFRVVVVKUFNLUFRKUFNMT1RLUVNKT1VIUFhMT1NLUFNOTk5KUFRMUVVLUFRKT1VKT1NLUFRLUVRMT1NMUFVAYGBLUFRLUFRAQEBLUFRLUFRLT1RJSUlLTlJLUFRLS1pMUFRLUFNLUFRMUFRKUVVLUFRMU1NLUFRLUFRLUVRLUFRMUFRMUVNLUFRLT1RLUFRKUVRJUFRLUFNKUFRMT1RKUVdJUlJLUFRLUVRKUFVLT1RLUFRLUFVLUFRLUFRNUlJNTVlKVVVEVVVNTU1VVVWAgIBLUFVMT1VMT1RLUFNOTlhLUFRLUFRLUFVLTlVMT1NLUFRMT1VOTllMUFRMUVFNUVVLUFQzZmZLUFRJUVVQUFBVVVVLT1NMUFVLUFRLT1QAAABMUFRNTVNLUVVNTVVMUFVMUFVMT1NJSVtKT1RLT1NKUVVVVVVNTVVLUVFLUFRLT1NHVVVLUFRKTlNKUFVLUVRMUFRKUVRKUVRLUFRLUFRLUVRLUFRRUVFLUFVLUFNKUFNLUFNLT1RLUFRKUFVLT1RLT1RLT1RLUVROTlVMUFRJUlJKUFRKT1RLT1RLUFRKUVVLUFRMUFRJUFdHUlJKT1RLUFNLUFRKUFRLUFRJUlJLUFRLUFRLUFRLT1RMTFVNU1NLUFRMUVRKUFRLUVNLUFRLUFVITlVKUFVLUVROTlNKUFVMUFRLUFRNUlJLUFNLUVRKT1NMUVRLUFVKUVNLUFRLUVVPT1hKUFNJT1VLT1NMUVNLUFRMUFNLUFRKTlJKUlJJTlNLUFRLUFVMT1VLUFRLUFRLUFRLUFQAAADa8LodAAAAz3RSTlMAC1mNwfI/3QaQ/uKUXy0gh5kNhjn8WjeCrko2CNqjBP3C1wdB7BGA38hAda0l+3NYqXll4KfVTEnWwGEmHJ2OXeftaX34NRQYDwoMArtUkVwa7vYzTor6VxfpLzz1BfBCEAlErLCkAbMrex5sb00OZEdIAyEs84QS+TRg1NjRT6DPq7wTZtyo2Zr0svc9OogkvTh/Z7fleMZ2IxmXn5K5vzvo4ZV6GyjFW4li5s0nyuQuMIPrMpxVcZvTa4x+HVYqgWjbosk+HzFtuMeq4+pXMtrjAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAAN1wAADdcBQiibeAAAAAd0SU1FB+IDHgsAAGxrpbQAAAPVSURBVFjD1Zf9X1NVHMc/MMA5UWKyQYVsyKCBOh+iqIQSyZgwpZwPWQhumOtJKMiMDEwlKkWkKLJEwLKyB1PStGft0Z4//1Ln7u5ud3O723W9Xunnh3u+33vP933PPfd+z/leQFZGpiErmykqO8uQmYEo5cxINVjRjBxVuHGmibNyZ8/JS1FzZufOommmMQy4gcw3Q5fM+eRcxSmw0AoUFt14kx6ElZabZat4HktgM9jJUl2DKOH8sqDhYHkFbiGdrNQFqChnVdBYwIVY5OLiJToBWMjFwXYpl+FWVkM3YBlvC7a3swYGGvQD7uCdwfYuLketoU4/oEoMW9LdvCfYXjVgBettaQGKV7IhLQDu5ar7ogCNbrd7tWjL3CE1CafZ3ZgI4FnD7LUqQIuUbZb78cA6JfW86+FYRbYkAKCxktwQAWyUYjY9iM0PhReAh9G6hdyYCIC2lvatqkcw+3w+v2htvpCkxC3zxSasCpDea7wGAR3bHomSwYba7RF3biAZ4NHYBfQxPK5265IBnnhyR5Q6ga6nIu7T18Ekpg3wd3RLcrQBdd1h5fQAz8jmziSAbaHZzoX/WdXk78JzvSHzeW3A7hf6JPXvAV7sC2tvBzz7ZHP/wLU+if8/4KXBapVeBta+EnFfTQGwNCqT2ovlRTKkek9ygLG1SqXNQE9BxB24LibxPwCYtzYU9qQBcBwQ030wKSEhYOcQnftdPBQvqGnYsTopIJdZbeJw+MrwkdcspGnv60kAWRwF3uCbV8QvEfvjmFNsvG9pA45wBfC2KB5j9M4BrhkBjpbQ5NAEHOY4cIwTrTYE1B0mOSX7+XR6tADH+a4H79HEE+9Xl34Qvl68iaHF0Ozlh1oATzmHR5TksYavF3ClYp7kR1oAfGxZ/wkpyotPRXHS3n7KFzybw3ql65SoDDW/RD+Oe0s+23K67ow0iN684MlmO2UDxmxOI4VcEKVVxudCSnFVyX2ycZbnbKkAYvWFi+e7xP3PWngBVwPAl3Z6T06Jf7NxxAPsYb9WdM94EVoHpTk5dwGZX4mh1PDrqB557NX6cfqGY0Cg1rp82iYV6BPAt2Lzi9Igt9sSxov/kwXo+k58QAOj3+MiXZfEy9wQ3eeQnf0//BhHNeILnuBPRvwsPf0O/hJAKScx3BB7v4vrGF/DuOQStys08Vfgslck2292dsYZ59Hfj/0RR+ebRSKd8gf+5F9SryKOZbQd5DwjUtciaUvZxaHLktP0N0/MFyc6dQAqJv+Riosi2bMK01V+ekQHQKh2iGeaQvYR0qEvWtJuZ7diTveNKua/ykKBgkauYAcAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDMtMzBUMTE6MDA6MDArMDI6MDDZZlSaAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAzLTMwVDExOjAwOjAwKzAyOjAwqDvsJgAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAASUVORK5CYII=", _imagePrefix = "data:image/png;base64,", _pageWidth = 0, _pageHeight = 0, _pdf = null, _numOfPages = 0, _dataChanged = !1, _completeBtnCallBack = null, VnptPdf = function (t) { var r = new function () { this.x = 0, this.y = 0, this.width = 0, this.height = 0, this.page = 1, this.fontSize = 8, this.imageSrc = "", this.rectangle = "", this.visibleType = SignatureVisibleType.BOTH, this.comments = [], this.comment = "" }; function e(t) { var e = t.getViewport(1); _pageWidth = Math.floor(e.width), _pageHeight = Math.floor(e.height), console.log("width=" + _pageWidth + ". height=" + _pageHeight); var i = t.getViewport(1 / 72 * c()), n = document.getElementById("dropHere"), a = n.getContext("2d"); n.height = i.height, n.width = i.width; var s = { canvasContext: a, viewport: i }; t.render(s), function () { _signBox = $("#dragThis"), _pdfPage = $("#dropHere"), _signImage = $("#signature-img"), _signText = $("#signature-text"), _pdfPage.show(), $(".pdf-working-area").show(); var t = _pdfPage[0].offsetLeft, e = _pdfPage[0].offsetTop; 0 == r.x && (r.x = 15); 0 == r.y && (r.y = _pageHeight - 15 - r.height); var i = e + 9 - (r.y + r.height - _pageHeight); _signBox.css({ top: i, left: t + 9 + r.x, position: "absolute" }), $("#signature-img").attr("src", "data:image/png;base64," + r.imageSrc), $("#signbox-xpos").val(r.x), $("#signbox-ypos").val(r.y), _signBox.draggable({ containment: $("#dropHere"), drag: function () { var t = _pdfPage[0].offsetLeft, e = _pdfPage[0].offsetTop, i = _signBox[0].offsetTop, n = _signBox[0].offsetLeft, a = ($(this).offset(), Math.floor((n - t) / c() * 72)); r.x = a; var s = Math.floor(_signBox[0].offsetHeight / c() * 72), d = _pageHeight - Math.floor((i - e) / c() * 72) - s; r.y = d, $("#signbox-xpos").val(a), $("#signbox-ypos").val(d) }, stop: function () { _pdfPage.offset().left, _pdfPage.offset().top; var t = $(this).offset(); t.left, t.top } }).resizable({ resize: function (t, e) { d($(this)) }, stop: function (t, e) { d($(this)) } }), $("#dropHere").droppable({ accept: "#dragThis", over: function () { $("#dragThis").draggable("option", "containment", $(this)) } }), $("input[type=radio][name=sign-visible-type]").change(function () { var t = $(this).val(); switch (t) { case "1": r.visibleType = SignatureVisibleType.ONLY_TEXT, _signImage.hide(), _signText.removeAttr("style"), _signText.css({ width: "100%" }); break; case "2": r.visibleType = SignatureVisibleType.BOTH, _signImage.removeAttr("style"), _signText.removeAttr("style"), _signText.css({ width: "50%" }); break; default: r.visibleType = SignatureVisibleType.ONLY_IMAGE, _signText.hide(), _signImage.removeAttr("style"), _signImage.css({ margin: "0px auto", float: "unset" }), _signImage.show() } }) }(), $(".sign-pos").bind("cut copy paste drag drop", function (t) { t.preventDefault() }) } function c() { return document.getElementById("dpi").offsetWidth } function d(t) { var e = Math.floor(t[0].offsetWidth / c() * 72), i = Math.floor(t[0].offsetHeight / c() * 72); r.width = e, r.height = i, $("#signbox-width").val(e), $("#signbox-height").val(i) } function h(t, e) { var i = Math.floor(e[0].offsetWidth / c() * 72), n = Math.floor(e[0].offsetHeight / c() * 72); r.comments[t].width = i, r.comments[t].height = n } function a() { $("#pdf-sign-page-btn").click(function () { var t = Number($("#pdf-sign-page").val()); isNaN(t) || t < 1 || t > _numOfPage ? alert("Số trang không hợp lệ.") : (r.page = t, _pdf.getPage(r.page).then(function (t) { e(t) })) }), $("#pdf-sign-font-btn").click(function () { var t = Number($("#pdf-sign-font").val()); if (isNaN(t) || t < 1 || 20 < t) alert("Cỡ chữ không hợp lệ"); else { r.fontSize = t; var e = Math.floor(t * c() / 72), i = e + "px", n = e + 1 + "px"; $("#signature-text span").css({ "font-size": i, "line-height": n }) } }) } function s() { $(document).on("change", "#pdf-sign-image-file :file", function (t) { if ($(this).get(0).files) { var e = $(this), i = (e.get(0).files && e.get(0).files.length, e.val().replace(/\\/g, "/").replace(/.*\//, "")); $("#pdf-sign-img-name").val(i); var n = e.get(0).files[0], a = new FileReader; a.addEventListener("load", function () { var t = ("" + this.result).substr(0, ("" + this.result).indexOf("base64,") + 7); r.imageSrc = this.result.replace(t, ""), $("#signature-img").attr("src", this.result) }), n && a.readAsDataURL(n) } }) } function m() { this.x = 0, this.y = 0, this.width = 0, this.height = 0, this.page = 1, this.rectangle = "", this.page = 1 } return r.x = 0, r.y = 0, r.width = 250, r.height = 60, t.initPlugin = function () { $("body").append(pdfWorkingArea), $("#pdf-complete").click(function () { $(".pdf-working-area").hide(), _completeBtnCallBack() }), $("#pdf-cancel").click(function () { $(".pdf-working-area").hide() }) }, t.initData = function (t, e) { r.imageSrc = _defaultImage, _completeBtnCallBack = e; var i = new FileReader; i.onload = function () { var t = new Uint8Array(this.result); PDFJS.getDocument(t).then(function (t) { _pdf = t, _numOfPage = t.numPages, $("#pdf-total-pages").text(" of " + t.numPages), t.getPage(1).then(function (t) { r.page = 1 }) }), a(), s(), _dataChanged = !0, $("#add-comment-btn").click(function () { !function () { var i = r.comments.length, t = "#comment" + i, e = $("#comment-text").val(), n = $("#comment-text-page").val(), a = "<tr><td>" + (i + 1) + '.</td><td><span class="pdf-size-lbl">Nội dung</span></td><td><input id="comment-text-' + i + '" class="sign-pos" type="text" value="' + e + '" /></td > <td><span class="pdf-size-lbl">Page </span></td> <td><input id="comment-text-page-' + i + '" class="sign-pos" value="' + n + '" type="text" /></td></tr >'; $("#pdf-comments-table").append(a), $("#comment-text-" + i).keyup(function () { var t, e; t = i, e = $("#comment-text-" + t).val(), r.comments[t].text = e, $("#comment-val-" + t).text(e) }), $(".pdf-page").append('<div id="comment' + i + '" class="pdf-comment"><span id="comment-val-' + i + '">' + e + "</span></div>"), $("#comment-text").val(""); var s = new m; s.text = e, s.page = n, r.comments.push(s), o = i, d = t, p = _pdfPage[0].offsetLeft, _pdfPage[0].offsetTop, l = p + 21, g = _pageHeight - 15 - 25, f = $(d), f.css({ top: g, left: p + 9 + l, position: "absolute" }), f.draggable({ containment: $("#dropHere"), drag: function () { var t = _pdfPage[0].offsetLeft, e = _pdfPage[0].offsetTop, i = f[0].offsetTop, n = f[0].offsetLeft, a = ($(this).offset(), Math.floor((n - t) / c() * 72)); r.comments[o].x = a - 6; var s = Math.floor(f[0].offsetHeight / c() * 72), d = _pageHeight - Math.floor((i - e) / c() * 72) - s + 6; r.comments[o].y = d }, stop: function () { _pdfPage.offset().left, _pdfPage.offset().top; var t = $(this).offset(); t.left, t.top } }).resizable({ resize: function (t, e) { h(o, $(this)) }, stop: function (t, e) { h(o, $(this)) } }), $("#dropHere").droppable({ accept: d, over: function () { f.draggable("option", "containment", $(this)) } }); var o, d, p, l, g, f }() }) }, i.readAsArrayBuffer(t) }, t.initDataBase64 = function (t, e) { r.imageSrc = _defaultImage, _completeBtnCallBack = e; var n = function (t) { var e = window.atob(t), n = e.length, a = new Uint8Array(new ArrayBuffer(n)); for (i = 0; i < n; i++)a[i] = e.charCodeAt(i); return a }(t); PDFJS.getDocument(n).then(function (t) { _pdf = t, _numOfPage = t.numPages, $("#pdf-total-pages").text(" of " + t.numPages), t.getPage(1).then(function (t) { r.page = 1 }) }), a(), s(), _dataChanged = !0 }, t.start = function () { _dataChanged ? (_dataChanged = !1, _pdf.getPage(r.page).then(function (t) { e(t) })) : $(".pdf-working-area").show() }, t.getPdfOptions = function () { r.rectangle = r.x + "," + r.y + "," + (r.x + r.width) + "," + (r.y + r.height), r.comment = ""; for (var t = 0; t < r.comments.length; t++)r.comments[t].rectangle = r.comments[t].x + "," + r.comments[t].y + "," + (r.comments[t].x + r.comments[t].width) + "," + (r.comments[t].y + r.comments[t].height), r.comment += r.comments[t].text + ";" + r.comments[t].rectangle + ";" + r.comments[t].page + "-"; return r.comment = r.comment.slice(0, -1), r }, t }(VnptPdf || {}), pdfWorkingArea = '<div id="dpi" style="height: 1in; left: -100%; position: absolute; top: -100%; width: 1in;"></div><div class="pdf-working-area">    <div class="pdf-action-menu">        <div class="pdf-action-menu-content">            <fieldset>                <legend>V? trí ch? ký</legend>                <table>                    <tr>                        <td>                            <span class="pdf-size-lbl">X Pos = </span>                        </td>                        <td>                            <input class="sign-pos" id="signbox-xpos" type="text" value="15" disabled />                        </td>                        <td>                            <span class="pdf-size-lbl">  Y Pos = </span>                        </td>                        <td>                            <input class="sign-pos" id="signbox-ypos" type="text" value="765" disabled />                        </td>                    </tr>                    <tr>                        <td>                            <span class="pdf-size-lbl">Width = </span>                        </td>                        <td>                            <input class="sign-pos" id="signbox-width" type="text" value="200" disabled />                        </td>                        <td>                            <span class="pdf-size-lbl">  Height = </span>                        </td>                        <td>                            <input class="sign-pos" id="signbox-height" type="text" value="60" disabled />                        </td>                    </tr>                    <tr>                        <td> </td>                    </tr>                    <tr>                        <td colspan="4">                            <span>Trang chứa chữ ký:</span>                        </td>                    </tr>                    <tr>                        <td></td>                        <td>                            <input type="text" id="pdf-sign-page" value="1" />                        </td>                        <td>                            <span class="pdf-size-lbl pdf-all-page-lbl" id="pdf-total-pages"></span>                        </td>                        <td>                            <button class="pdf-btn" id="pdf-sign-page-btn" style="width: 70px;">Set</button>                        </td>                    </tr>                    <tr>                        <td> </td>                    </tr>                    <tr>                        <td colspan="4">                            <span>Cỡ chữ hiển thị: </span>                        </td>                    </tr>                    <tr>                        <td></td>                        <td>                            <input type="text" id="pdf-sign-font" value="8" />                        </td>                        <td> </td>                        <td>                            <button class="pdf-btn" id="pdf-sign-font-btn" style="width: 70px;">Set</button>                        </td>                    </tr>                </table>            </fieldset>            <fieldset>                <legend>Ki?u hi?n th? ch? ký</legend>                <div>                    <input type="radio" name="sign-visible-type" value="1"> Chỉ hiển thị text<br />                    <input type="radio" name="sign-visible-type" value="2" checked> Hiển thị text và hình ảnh<br />                    <input type="radio" name="sign-visible-type" value="3"> Chỉ hiển thị hình ảnh<br />                </div>                <div>                    <br />                    <label>Tùy chọn hình hảnh</label>                    <div class="pdf-input-group">                        <input id="pdf-sign-img-name" type="text" class="pdf-file-name"                               readonly="readonly">                        <span class="pdf-input-group-btn">                            <span class="pdf-btn pdf-btn-file" id="pdf-sign-image-file">                                ... <input id="select-file" name="SetupFile" type="file"                                           accept="image/x-png,image/gif,image/jpeg" required>                            </span>                        </span>                    </div>                </div>            </fieldset>            <fieldset>                <legend>Thêm comments</legend>                <div class="pdf-input-group">                    <div class="pdf-size-row">                        <div id="pdf-comments">                            <table id="pdf-comments-table">                            </table>                            <br />                            <table>                                <tr>                                    <td>   </td>                                    <td>                                        <span class="pdf-size-lbl">Nội dung</span>                                    </td>                                    <td>                                        <input id="comment-text" class="sign-pos" type="text" />                                    </td>                                    <td>                                        <span class="pdf-size-lbl">Page </span>                                    </td>                                    <td>                                        <input id="comment-text-page" class="sign-pos" type="text" />                                    </td>                                </tr>                                <tr></tr>                                <tr>                                    <td colspan="4">                                        <button class="pdf-btn" id="add-comment-btn" style="width: 70px;">Thêm</button>                                    </td>                                </tr>                            </table>                        </div>                    </div>                </div>            </fieldset>            <br />            <br />            <table>                <tr>                    <td>                        <button class="pdf-btn" id="pdf-complete">Ký dữ liệu</button>                    </td>                    <td>                        <button class="pdf-btn pdf-btn-error" id="pdf-cancel">Hủy</button>                    </td>                </tr>            </table>        </div>    </div>    <div class="pdf-page">        <canvas id="dropHere" class="pdf-viewport"></canvas>        <div id="dragThis">            <img id="signature-img" src="/Content/Images/avatar.jpg" />            <div id="signature-text">                <span>Ký bởi: Tên chủ chứng thư</span>                <br />                <span>Thời gian ký: dd/MM/yyyy</span>            </div>        </div>    </div></div>';